<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ballpark Details - yakyuu.jp</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="style.css" id="main-stylesheet">
    <style>
        .page-container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Ballpark Header - matching teams page style */
        .ballpark-header-section {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }
        
        .ballpark-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: #BC002D;
            margin-bottom: 0.5rem;
        }
        

        
        .ballpark-details {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .ballpark-stat {
            text-align: center;
        }
        
        .ballpark-stat .label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .ballpark-stat .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        
        /* Sections - matching teams page style */
        .ballpark-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .ballpark-section h2 {
            color: #BC002D;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #BC002D;
            padding-bottom: 0.5rem;
        }
        
        .factors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .factor-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        
        .factor-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .factor-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .factor-description {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.5rem;
        }
        

        
        .dimensions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .dimension-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        
        .dimension-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .dimension-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }
        
        /* Loading and error states */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #BC002D;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .page-container {
                padding: 1rem;
            }
            
            .ballpark-header {
                padding: 2rem 1rem;
            }
            
            .ballpark-name {
                font-size: 2rem;
            }
            
            .ballpark-info {
                grid-template-columns: 1fr;
            }
        }

        /* --- COPIED FROM TEAMS.HTML FOR STATS/GAMES FUNCTIONALITY --- */
        .toggle-buttons {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            justify-content: center;
        }
        
        .toggle-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            color: #666;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .toggle-btn.active {
            background: #BC002D;
            color: white;
            border-color: #BC002D;
        }
        
        .toggle-btn:hover {
            border-color: #BC002D;
            color: #BC002D;
        }
        
        .toggle-btn.active:hover {
            background: #a00025;
            color: white;
        }

        .content-section {
            margin-bottom: 3rem;
        }

        .table-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: flex-start;
        }
        .toggle-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .section-label {
            font-size: 0.8rem;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
        }
        .game-type-section .section-label {
            margin-left: 2rem;
        }
        .toggle-button {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            color: #666;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .toggle-button.active {
            background: #BC002D;
            color: white;
            border-color: #BC002D;
        }
        .toggle-button:hover {
            border-color: #BC002D;
            color: #BC002D;
        }
        .toggle-button.active:hover {
            background: #a00025;
            color: white;
        }

        .table-section {
            margin-bottom: 3rem;
        }
        .table-section h2 {
            color: #BC002D;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        .stats-container {
            margin-top: 2rem;
        }
        .basic-stats, .advanced-stats {
            margin-bottom: 2rem;
        }
        .basic-stats.full-width {
            width: 100%;
        }
        .stats-title {
            color: #BC002D;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .split-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .split-toggle button {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            color: #666;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 100px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .split-toggle button.active {
            background: #BC002D;
            color: white;
            border-color: #BC002D;
        }
        .split-toggle button.multi-active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .split-toggle button:hover {
            border-color: #BC002D;
            color: #BC002D;
        }
        .split-toggle button.active:hover {
            background: #a00025;
            color: white;
        }
        .split-helper-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 1rem;
            font-style: italic;
        }
        .split-helper-text a {
            color: #BC002D;
            text-decoration: none;
            font-weight: 500;
        }
        .split-helper-text a:hover {
            text-decoration: underline;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        .stats-table th {
            background: #BC002D;
            color: white;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 500;
            border-right: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        .stats-table th:hover {
            background: #a0001f;
        }
        .stats-table th.sortable::after {
            content: ' ↕';
            color: rgba(255,255,255,0.7);
            font-size: 12px;
        }
        .stats-table th.sort-asc::after {
            content: ' ↑';
            color: #fff;
        }
        .stats-table th.sort-desc::after {
            content: ' ↓';
            color: #fff;
        }
        .stats-table th:last-child {
            border-right: none;
        }
        .stats-table td {
            padding: 0.5rem;
            text-align: center;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
        }
        .stats-table td:last-child {
            border-right: none;
        }
        .stats-table tr:last-child td {
            border-bottom: none;
        }
        .stats-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .stats-table tr:hover {
            background: #e9ecef;
        }
        .career-row {
            background: #333 !important;
            color: white;
            font-weight: bold;
        }
        .career-row:hover {
            background: #444 !important;
        }
        .season-year {
            font-weight: bold;
            color: #BC002D;
        }

        /* Recent Games Styles */
        .recent-games-controls {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .recent-games-controls label {
            font-weight: bold;
            color: #BC002D;
            margin-right: 1rem;
        }
        .recent-games-controls select {
            padding: 0.5rem;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            background: white;
            color: #333;
        }
        .recent-games-controls select:focus {
            outline: none;
            border-color: #BC002D;
        }

        .game-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s ease;
        }
        
        .game-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .game-date {
            font-weight: bold;
            color: #BC002D;
        }

        .game-type {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #666;
        }

        .game-matchup {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .game-score {
            font-weight: bold;
            color: #333;
        }

        .game-details {
            font-size: 0.9rem;
            color: #666;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        #recent-games-container {
            min-height: 200px;
        }

        .show-more-button {
            background: #BC002D;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .show-more-button:hover {
            background: #a00025;
        }

        .loading-message, .error-message {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }

        .error-message {
            color: #e74c3c;
        }

        /* Game Line Score Styles - matching teams page */
        .game-line-score {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            font-size: 0.9rem;
        }
        
        .game-line-score th {
            background: #f8f9fa;
            color: #333;
            padding: 0.5rem;
            text-align: center;
            font-weight: 500;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
        }
        
        .game-line-score th:last-child {
            border-right: none;
        }
        
        .game-line-score td {
            padding: 0.5rem;
            text-align: center;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
        }
        
        .game-line-score td:last-child {
            border-right: none;
        }
        
        .game-line-score tr:last-child td {
            border-bottom: none;
        }
        
        .game-line-score .team-name {
            font-weight: 500;
            color: #333;
            text-align: left;
            padding-left: 1rem;
            font-size: 0.85rem;
        }
        
        .game-line-score .winning-score {
            font-weight: bold;
            color: #BC002D;
            font-size: 1.1rem;
        }
        
        .game-info-header {
            background: #BC002D !important;
            color: white !important;
            font-size: 0.85rem !important;
            font-weight: 500 !important;
            text-align: center !important;
            padding: 0.75rem !important;
        }

        /* Recent Games Container */
        #recent-games-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Games Section */
        .games-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .games-section h2 {
            color: #BC002D;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #BC002D;
            padding-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <script>
        // Fix paths based on protocol (file:// vs http://)
        if (window.location.protocol !== 'file:') {
            // We're on a web server, use absolute paths
            document.getElementById('main-stylesheet').href = '/style.css';
            document.getElementById('main-logo').src = '/logo.png';
            
            // Add absolute font path for web server
            const style = document.createElement('style');
            style.textContent = `
                @font-face {
                    font-family: 'Titillium Web';
                    src: url('/TitilliumWeb-Regular.ttf') format('truetype');
                    font-weight: normal;
                    font-style: normal;
                }
            `;
            document.head.appendChild(style);
        }
    </script>
    
    <!-- Large Header with Logo -->
    <header class="main-header">
        <div class="header-content">
            <a href="/" class="logo-link">
                <img src="logo.png" alt="yakyuu.jp" class="logo-image" id="main-logo">
            </a>
        </div>
    </header>

    <!-- Red Navigation Bar -->
    <nav class="main-nav">
        <div class="nav-content">
            <ul class="nav-menu">
                <li><a href="/games">Games</a></li>
                <li><a href="/players">Players</a></li>
                <li><a href="/teams">Teams/Standings</a></li>
                <li><a href="/ballparks">Ballparks</a></li>
                <li><a href="/advanced">Advanced Stat Finder</a></li>
                <li><a href="https://github.com/pluckhahn/yakyuu">Downloadable Data</a></li>
                <li><a href="/about">About</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            Loading ballpark data...
        </div>

        <!-- Error State -->
        <div id="error" class="error" style="display: none;">
            Error loading ballpark data
        </div>

        <!-- Ballpark Content -->
        <div id="ballpark-content" style="display: none;">

            
            <!-- Ballpark Header -->
            <div class="ballpark-header-section">
                <h1 class="ballpark-name" id="ballpark-name">Loading...</h1>
                
                <div class="ballpark-details">
                    <div class="ballpark-stat">
                        <div class="label">City</div>
                        <div class="value" id="ballpark-city">-</div>
                    </div>
                    <div class="ballpark-stat">
                        <div class="label">Home Team</div>
                        <div class="value" id="ballpark-home-team">-</div>
                    </div>
                    <div class="ballpark-stat">
                        <div class="label">Park Factor</div>
                        <div class="value" id="ballpark-park-factor">-</div>
                    </div>
                    <div class="ballpark-stat">
                        <div class="label">Game Sample Size</div>
                        <div class="value" id="ballpark-sample-size">-</div>
                    </div>
                </div>
            </div>

            <!-- Toggle Buttons -->
            <div class="toggle-buttons">
                <button id="ballpark-stats-btn" class="toggle-btn active" onclick="showBallparkStats()">Ballpark Stats</button>
                <button id="recent-games-btn" class="toggle-btn" onclick="showRecentGames()">Recent Games</button>
            </div>

            <!-- Ballpark Stats Section -->
            <div id="ballpark-stats-section" class="content-section">
                <!-- Ballpark Stats Controls -->
                <div class="table-toggle">
                    <div class="toggle-section">
                        <div class="section-label">Game Type</div>
                        <div class="split-toggle">
                            <button class="game-type-button active" data-game-type="公式戦">Regular Season</button>
                            <button class="game-type-button" data-game-type="ファーストステージ">Postseason First</button>
                            <button class="game-type-button" data-game-type="ファイナルステージ">Postseason Final</button>
                            <button class="game-type-button" data-game-type="日本シリーズ">Japan Series</button>
                        </div>
                    </div>
                </div>

                <!-- Batting Stats Section -->
                <div class="table-section" id="ballpark-batting-section">
                    <div class="toggle-section">
                        <div class="section-label">Split</div>
                        <div class="split-toggle">
                            <button class="active">Overall</button>
                            <button>Home</button>
                            <button>Road</button>
                            <button>Wins</button>
                            <button>Losses</button>
                        </div>
                        <div class="split-helper-text">Hold Ctrl/Cmd to select multiple splits (AND logic). For custom splits, visit <a href="/advanced">Advanced Stat Finder</a></div>
                    </div>
                    <h2>Batting Statistics</h2>
                    <div class="stats-container">
                        <div class="basic-stats full-width">
                            <div class="loading" id="ballpark-batting-basic-loading">Loading basic statistics...</div>
                            <table class="stats-table" id="ballpark-batting-basic-table" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Season</th>
                                        <th>G</th>
                                        <th>PA</th>
                                        <th>AB</th>
                                        <th>H</th>
                                        <th>R</th>
                                        <th>2B</th>
                                        <th>3B</th>
                                        <th>HR</th>
                                        <th>TB</th>
                                        <th>RBI</th>
                                        <th>K</th>
                                        <th>BB</th>
                                        <th>HBP</th>
                                        <th>SAC</th>
                                        <th>GIDP</th>
                                        <th>AVG</th>
                                        <th>SLG</th>
                                        <th>ISO</th>
                                        <th>BABIP</th>
                                    </tr>
                                </thead>
                                <tbody id="ballpark-batting-basic-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pitching Stats Section -->
                <div class="table-section" id="ballpark-pitching-section">
                    <h2>Pitching Statistics</h2>
                    <div class="stats-container">
                        <div class="basic-stats full-width">
                            <div class="loading" id="ballpark-pitching-basic-loading">Loading pitching statistics...</div>
                            <table class="stats-table" id="ballpark-pitching-basic-table" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Season</th>
                                        <th>App</th>
                                        <th>IP</th>
                                        <th>W</th>
                                        <th>L</th>
                                        <th>SV</th>
                                        <th>HLD</th>
                                        <th>K</th>
                                        <th>BB</th>
                                        <th>BK</th>
                                        <th>HBP</th>
                                        <th>GIDP%</th>
                                        <th>R</th>
                                        <th>ER</th>
                                        <th>H</th>
                                        <th>2B</th>
                                        <th>3B</th>
                                        <th>HR</th>
                                        <th>ERA</th>
                                        <th>WHIP</th>
                                        <th>BAA</th>
                                    </tr>
                                </thead>
                                <tbody id="ballpark-pitching-basic-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Games Section -->
            <div id="recent-games-section" class="content-section" style="display: none;">
                <div class="games-section">
                    <h2>Recent Games</h2>
                    
                    <div class="recent-games-controls">
                        <div class="toggle-section">
                            <div class="section-label">Game Type</div>
                            <div class="split-toggle">
                                <button class="recent-game-type-button active" data-game-type="">All Games</button>
                                <button class="recent-game-type-button" data-game-type="公式戦">Regular Season</button>
                                <button class="recent-game-type-button" data-game-type="ファーストステージ">Postseason First</button>
                                <button class="recent-game-type-button" data-game-type="ファイナルステージ">Postseason Final</button>
                                <button class="recent-game-type-button" data-game-type="日本シリーズ">Japan Series</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="recent-games-container">
                        <!-- Games will be loaded here as individual cards -->
                    </div>
                    
                    <div id="show-more-container" style="display: none; text-align: center; margin-top: 1rem;">
                        <button id="show-more-btn" class="show-more-button">Show 10 More</button>
                    </div>
                    
                    <div id="recent-games-loading" class="loading-message" style="display: none;">
                        Loading recent games...
                    </div>
                    
                    <div id="recent-games-error" class="error-message" style="display: none;">
                        Failed to load recent games.
                    </div>
                </div>
            </div>


        </div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:5000/api' : '/api';
        
        // Check if we're running from file:// and if Flask server is accessible
        async function checkServerConnection() {
            if (window.location.protocol === 'file:') {
                try {
                    console.log('Testing server connection to http://localhost:5000/api/ballparks...');
                    const response = await fetch('http://localhost:5000/api/ballparks', {
                        method: 'GET',
                        mode: 'cors'
                    });
                    console.log('Server test response:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                    }
                    console.log('✅ Flask server is running and accessible');
                    return true;
                } catch (error) {
                    console.error('❌ Flask server connection test failed:', error);
                    console.log('This might be due to CORS or the server not running');
                    
                    // Try a simpler test - just check if we can reach the base URL
                    try {
                        console.log('Trying alternative test to http://localhost:5000/...');
                        const baseResponse = await fetch('http://localhost:5000/', {
                            method: 'GET',
                            mode: 'no-cors'
                        });
                        console.log('Base URL test completed (no-cors mode)');
                        console.log('⚠️ Server might be running but CORS is blocking API calls');
                        return true; // Assume server is running, let the actual API calls handle errors
                    } catch (baseError) {
                        console.error('❌ Base URL test also failed:', baseError);
                        showServerError();
                        return false;
                    }
                }
            }
            return true;
        }
        
        function showServerError() {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #dc3545;
                color: white;
                padding: 1rem 2rem;
                border-radius: 5px;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            `;
            errorDiv.innerHTML = `
                ⚠️ Flask Server Not Running!<br>
                <small>Please start the Flask server with: python app.py</small>
            `;
            document.body.appendChild(errorDiv);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 10000);
        }
        
        // Get ballpark name from URL path (e.g., /ballparks/Tokyo%20Dome)
        function getBallparkName() {
            const path = window.location.pathname;
            const pathParts = path.split('/');
            
            // For URLs like /ballparks/Tokyo%20Dome, get the last part
            if (pathParts.length >= 3 && pathParts[1] === 'ballparks') {
                return decodeURIComponent(pathParts[2]);
            }
            
            // Fallback: check for old-style query parameters for backward compatibility
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('name') || urlParams.get('id') || 'ZOZOマリン'; // Default for testing
        }
        
        // Load ballpark data
        async function loadBallparkData() {
            const ballparkName = getBallparkName();
            console.log('Ballpark name from URL:', ballparkName);
            console.log('Current URL:', window.location.href);
            
            const apiUrl = `${API_BASE}/ballparks/${encodeURIComponent(ballparkName)}`;
            console.log('API URL:', apiUrl);
            
            try {
                console.log('Starting fetch request...');
                const startTime = Date.now();
                
                const response = await fetch(apiUrl);
                const fetchTime = Date.now() - startTime;
                console.log(`Fetch completed in ${fetchTime}ms`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Ballpark not found: ${response.status}`);
                }
                
                const ballpark = await response.json();
                const totalTime = Date.now() - startTime;
                console.log(`Total API call completed in ${totalTime}ms`);
                console.log('Ballpark data:', ballpark);
                
                populateBallparkData(ballpark);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('ballpark-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading ballpark data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error loading ballpark data: ${error.message}`;
            }
        }
        
        // Populate ballpark data
        function populateBallparkData(ballpark) {
            // Basic info - combine Japanese and English names
            const parkName = ballpark.park_name || 'Unknown';
            const parkNameEn = ballpark.park_name_en || '';
            const combinedName = parkNameEn ? `${parkName} (${parkNameEn})` : parkName;
            document.getElementById('ballpark-name').textContent = combinedName;
            document.getElementById('ballpark-city').textContent = ballpark.city || '-';
            
            // Park factor in header - USING WORKING CODE FROM STATS SECTION
            const pfRunsHeader = ballpark.pf_runs ? ballpark.pf_runs.toFixed(3) : '1.000';
            const pfHeaderElement = document.getElementById('ballpark-park-factor');
            pfHeaderElement.textContent = pfRunsHeader;
            
            // Color code the park factor in header
            if (ballpark.pf_runs > 1.05) {
                pfHeaderElement.style.color = '#e74c3c'; // Red for hitter-friendly
            } else if (ballpark.pf_runs < 0.95) {
                pfHeaderElement.style.color = '#3498db'; // Blue for pitcher-friendly
            } else {
                pfHeaderElement.style.color = '#27ae60'; // Green for neutral
            }
            
            // Game sample size in header - RESTORED (THIS WORKS FINE)
            document.getElementById('ballpark-sample-size').textContent = ballpark.games_sample_size || '0';
            
            // Home team (use team name if available, fallback to team ID)
            const homeTeamDisplay = ballpark.team_name_en || ballpark.team_name || ballpark.home_team || '-';
            document.getElementById('ballpark-home-team').textContent = homeTeamDisplay;
            
            // Park factors section removed - park factor now displayed in header only
            
            // Update page title
            document.title = `${ballpark.park_name_en || ballpark.park_name} - yakyuu.jp`;
        }
        
        // --- COPIED FROM TEAMS.HTML FOR STATS/GAMES FUNCTIONALITY ---
        
        // Toggle between ballpark stats and recent games
        function showBallparkStats() {
            document.getElementById('ballpark-stats-btn').classList.add('active');
            document.getElementById('recent-games-btn').classList.remove('active');
            document.getElementById('ballpark-stats-section').style.display = 'block';
            document.getElementById('recent-games-section').style.display = 'none';
        }

        function showRecentGames() {
            document.getElementById('ballpark-stats-btn').classList.remove('active');
            document.getElementById('recent-games-btn').classList.add('active');
            document.getElementById('ballpark-stats-section').style.display = 'none';
            document.getElementById('recent-games-section').style.display = 'block';
            
            // Load recent games if not already loaded
            if (!window.recentGamesLoaded) {
                loadRecentGames();
                window.recentGamesLoaded = true;
            }
        }

        // Global variables for ballpark stats
        let currentBallparkId = null;
        
        // Helper functions (copied from teams.html)

        // Recent games functionality
        let currentOffset = 0;
        const gamesPerPage = 10;

        async function loadRecentGames(reset = true) {
            const ballparkName = getBallparkName();
            if (!ballparkName) return;

            if (reset) {
                currentOffset = 0;
            }

            const loadingEl = document.getElementById('recent-games-loading');
            const errorEl = document.getElementById('recent-games-error');
            const containerEl = document.getElementById('recent-games-container');
            const showMoreContainer = document.getElementById('show-more-container');

            if (reset) {
                containerEl.innerHTML = '';
                showMoreContainer.style.display = 'none';
            }

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';

            try {
                const activeGameTypeBtn = document.querySelector('.recent-game-type-button.active');
                const gameType = activeGameTypeBtn ? activeGameTypeBtn.dataset.gameType : '';
                
                let apiUrl = `${API_BASE}/ballparks/${encodeURIComponent(ballparkName)}/recent-games?limit=${gamesPerPage}&offset=${currentOffset}`;
                if (gameType) {
                    apiUrl += `&game_type=${encodeURIComponent(gameType)}`;
                }

                console.log('Recent games API URL:', apiUrl);
                const response = await fetch(apiUrl);
                console.log('Recent games response status:', response.status);
                const data = await response.json();
                console.log('Recent games data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Render games
                data.games.forEach(game => {
                    const gameCard = createGameCard(game);
                    containerEl.appendChild(gameCard);
                });

                // Update offset and show more button
                currentOffset += gamesPerPage;
                if (data.games.length === gamesPerPage) {
                    showMoreContainer.style.display = 'block';
                } else {
                    showMoreContainer.style.display = 'none';
                }

                loadingEl.style.display = 'none';
            } catch (error) {
                console.error('Error loading recent games:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = 'Failed to load recent games.';
            }
        }

        function createGameCard(game) {
            const gameCard = document.createElement('div');
            gameCard.className = 'game-card';
            
            // Format date as yyyy/mm/dd - avoid timezone issues by parsing manually
            const dateParts = game.date.split('-');
            const date = `${dateParts[0]}/${dateParts[1]}/${dateParts[2]}`;
            
            // Use the data from API with proper formatting
            const homeTeam = `${game.home_team_name} (${game.home_team_name_en})`;
            const awayTeam = `${game.away_team_name} (${game.away_team_name_en})`;
            const homeRuns = game.home_runs;
            const awayRuns = game.away_runs;
            const homeHits = game.home_hits || 0;
            const awayHits = game.away_hits || 0;
            const homeErrors = game.home_errors || 0;
            const awayErrors = game.away_errors || 0;
            
            // Determine winning team styling
            const homeScoreClass = homeRuns > awayRuns ? 'winning-score' : '';
            const awayScoreClass = awayRuns > homeRuns ? 'winning-score' : '';
            
            // Format game type with English translation
            const gameTypeMap = {
                '公式戦': 'Regular Season',
                '交流戦': 'Interleague',
                'ファーストステージ': 'First Stage',
                'ファイナルステージ': 'Final Stage', 
                '日本シリーズ': 'Japan Series'
            };
            const gameTypeEn = gameTypeMap[game.gametype] || game.gametype;
            const gameTypeDisplay = `${game.gametype} (${gameTypeEn})`;
            
            // Format game number
            const gameNumberDisplay = game.game_number ? `第${game.game_number}回戦 (Game ${game.game_number})` : '';
            
            // Format ballpark info (since this is a ballpark page, we can show the ballpark name)
            const ballparkDisplay = game.park_name && game.park_name_en ? 
                `${game.park_name} (${game.park_name_en})` : 
                (game.ballpark || '');
            
            // Create the game info header that will go in the table
            const gameInfoHeader = `${date} | ${gameTypeDisplay}${gameNumberDisplay ? ' | ' + gameNumberDisplay : ''}${ballparkDisplay ? ' | ' + ballparkDisplay : ''}`;
            
            gameCard.innerHTML = `
                <table class="game-line-score">
                    <thead>
                        <tr>
                            <th colspan="4" class="game-info-header">${gameInfoHeader}</th>
                        </tr>
                        <tr>
                            <th>Team</th>
                            <th>R</th>
                            <th>H</th>
                            <th>E</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="team-name">${awayTeam}</td>
                            <td class="${awayScoreClass}">${awayRuns}</td>
                            <td>${awayHits}</td>
                            <td>${awayErrors}</td>
                        </tr>
                        <tr>
                            <td class="team-name">${homeTeam}</td>
                            <td class="${homeScoreClass}">${homeRuns}</td>
                            <td>${homeHits}</td>
                            <td>${homeErrors}</td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            return gameCard;
        }

        // Table sorting functionality
        function makeSortable(table) {
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                // Skip the first column (Season) and make others sortable
                if (index > 0) {
                    header.classList.add('sortable');
                    header.addEventListener('click', () => sortTable(table, index));
                }
            });
        }

        function sortTable(table, columnIndex) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const header = table.querySelectorAll('th')[columnIndex];
            
            // Determine sort direction
            let isAscending = true;
            if (header.classList.contains('sort-asc')) {
                isAscending = false;
            }
            
            // Clear all sort indicators
            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Set current sort indicator
            header.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
            
            // Separate career row from season rows
            const careerRow = rows.find(row => row.classList.contains('career-row'));
            const seasonRows = rows.filter(row => !row.classList.contains('career-row'));
            
            // Sort season rows
            seasonRows.sort((a, b) => {
                const aValue = getCellValue(a, columnIndex);
                const bValue = getCellValue(b, columnIndex);
                
                // Handle numeric vs string comparison
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAscending ? aNum - bNum : bNum - aNum;
                } else {
                    return isAscending ? 
                        aValue.localeCompare(bValue) : 
                        bValue.localeCompare(aValue);
                }
            });
            
            // Clear tbody and re-append sorted rows
            tbody.innerHTML = '';
            seasonRows.forEach(row => tbody.appendChild(row));
            
            // Always append career row at the end if it exists
            if (careerRow) {
                tbody.appendChild(careerRow);
            }
        }

        function getCellValue(row, columnIndex) {
            const cell = row.cells[columnIndex];
            return cell ? cell.textContent.trim() : '';
        }

        // Debug functions
        function debugCurrentState() {
            console.log('=== CURRENT STATE DEBUG ===');
            console.log('currentGameTypes:', currentGameTypes);
            console.log('currentBattingSplits:', currentBattingSplits);
            console.log('currentPitchingSplits:', currentPitchingSplits);
            console.log('currentBallparkId:', currentBallparkId);
            console.log('getBallparkName():', getBallparkName());
            
            // Check active buttons
            const activeGameTypeButtons = document.querySelectorAll('.game-type-button.active');
            const activeSplitButtons = document.querySelectorAll('.split-button.active');
            console.log('Active game type buttons:', activeGameTypeButtons.length, activeGameTypeButtons);
            console.log('Active split buttons:', activeSplitButtons.length, activeSplitButtons);
        }
        
        function testAPICall() {
            console.log('=== TESTING API CALL ===');
            const ballparkName = getBallparkName();
            const gameTypesParam = currentGameTypes.map(gt => `game_types[]=${encodeURIComponent(gt)}`).join('&');
            const splitsParam = currentBattingSplits.map(split => `splits[]=${encodeURIComponent(split)}`).join('&');
            const url = `${API_BASE}/ballparks/${encodeURIComponent(ballparkName)}/batting?${gameTypesParam}&${splitsParam}`;
            console.log('Test URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('Test response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Test response data:', data);
                })
                .catch(error => {
                    console.error('Test API error:', error);
                });
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM loaded, setting up event listeners...');
            console.log('Protocol:', window.location.protocol);
            console.log('API_BASE:', API_BASE);
            
            // Fix logo path for localhost
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const logoImg = document.querySelector('.logo-image');
                if (logoImg) {
                    logoImg.src = '/logo.png';
                }
            }
            
            // Event listeners are now set up directly in the script
            
            // Show debug section if debug=1 in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('debug') === '1') {
                document.getElementById('debug-section').style.display = 'block';
            }
            
            // Hide usage info if running from localhost
            if (window.location.protocol === 'http:' && window.location.hostname === 'localhost') {
                document.getElementById('usage-info').style.display = 'none';
            }
            
            // Check server connection (but don't block on it)
            if (window.location.protocol === 'file:') {
                console.log('Running from file://, will attempt to connect to Flask server...');
                checkServerConnection(); // Don't await, just run it
            }
            
            // Then load data (always attempt this)
            loadBallparkData();
            
            // Load initial ballpark stats
            setTimeout(() => {
                loadBallparkStats('batting');
                loadBallparkStats('pitching');
            }, 500);
        });
        
        // --- BALLPARK STATS LOGIC ---
        function getActiveGameTypes() {
            return Array.from(document.querySelectorAll('.game-type-button.active')).map(btn => btn.dataset.gameType);
        }
        
        function getActiveSplits() {
            const buttons = document.querySelectorAll('.split-toggle button:not(.game-type-button)');
            const activeSplits = [];
            buttons.forEach(button => {
                if (button.classList.contains('active') || button.classList.contains('multi-active')) {
                    activeSplits.push(button.textContent.trim());
                }
            });
            return activeSplits.length > 0 ? activeSplits : ['Overall'];
        }

        function formatInnings(ip) {
            // Convert decimal innings to standard baseball format (e.g., 123.33 -> 123.1, 123.67 -> 123.2)
            if (!ip) return '0.0';
            const wholeInnings = Math.floor(ip);
            const fraction = ip - wholeInnings;
            let outs = Math.round(fraction * 3);
            if (outs >= 3) {
                return (wholeInnings + 1) + '.0';
            }
            return wholeInnings + '.' + outs;
        }

        async function loadBallparkStats(statType) {
            // statType: 'batting' or 'pitching'
            const ballparkName = getBallparkName();
            if (!ballparkName) return;
            
            const gameTypes = getActiveGameTypes();
            const splits = getActiveSplits();
            const url = `${API_BASE}/ballparks/${encodeURIComponent(ballparkName)}/${statType}?` +
                gameTypes.map(gt => `game_types[]=${encodeURIComponent(gt)}`).join('&') +
                (splits.length ? '&' + splits.map(s => `splits[]=${encodeURIComponent(s)}`).join('&') : '');
            console.log(`[DEBUG] Fetching ballpark stats:`, url);
            try {
                const resp = await fetch(url);
                console.log(`[DEBUG] Response status:`, resp.status);
                if (!resp.ok) {
                    const msg = `API error: ${resp.status} ${resp.statusText}`;
                    if (statType === 'batting') {
                        document.getElementById('ballpark-batting-basic-loading').innerHTML = `<div class='error'>${msg}</div>`;
                    } else {
                        document.getElementById('ballpark-pitching-basic-loading').innerHTML = `<div class='error'>${msg}</div>`;
                    }
                    return;
                }
                const data = await resp.json();
                console.log(`[DEBUG] API data:`, data);
                if (statType === 'batting') {
                    renderBallparkBattingStats(data);
                } else {
                    renderBallparkPitchingStats(data);
                }
            } catch (e) {
                console.error(`[DEBUG] Fetch error:`, e);
                if (statType === 'batting') {
                    document.getElementById('ballpark-batting-basic-loading').innerHTML = `<div class='error'>Fetch error: ${e.message}</div>`;
                } else {
                    document.getElementById('ballpark-pitching-basic-loading').innerHTML = `<div class='error'>Fetch error: ${e.message}</div>`;
                }
            }
        }

        function renderBallparkBattingStats(data) {
            const basicTbody = document.getElementById('ballpark-batting-basic-tbody');
            const basicTable = document.getElementById('ballpark-batting-basic-table');
            const basicLoading = document.getElementById('ballpark-batting-basic-loading');
            basicLoading.style.display = 'none';
            basicTable.style.display = 'table';
            basicTbody.innerHTML = '';
            if (data.seasons && data.seasons.length > 0) {
                data.seasons.forEach(season => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="season-year">${season.season}</td>
                        <td>${season.g || 0}</td>
                        <td>${season.pa || 0}</td>
                        <td>${season.ab || 0}</td>
                        <td>${season.h || 0}</td>
                        <td>${season.r || 0}</td>
                        <td>${season.doubles || 0}</td>
                        <td>${season.triples || 0}</td>
                        <td>${season.hr || 0}</td>
                        <td>${season.tb || 0}</td>
                        <td>${season.rbi || 0}</td>
                        <td>${season.so || 0}</td>
                        <td>${season.bb || 0}</td>
                        <td>${season.hbp || 0}</td>
                        <td>${season.sac || 0}</td>
                        <td>${season.gidp || 0}</td>
                        <td>${season.avg ? season.avg.toFixed(3) : '.000'}</td>
                        <td>${season.slg ? season.slg.toFixed(3) : '.000'}</td>
                        <td>${season.iso ? season.iso.toFixed(3) : '.000'}</td>
                        <td>${season.babip ? season.babip.toFixed(3) : '.000'}</td>
                    `;
                    basicTbody.appendChild(row);
                });
            }

            
            // Make table sortable
            makeSortable(basicTable);
        }

        function renderBallparkPitchingStats(data) {
            const basicTbody = document.getElementById('ballpark-pitching-basic-tbody');
            const basicTable = document.getElementById('ballpark-pitching-basic-table');
            const basicLoading = document.getElementById('ballpark-pitching-basic-loading');
            basicLoading.style.display = 'none';
            basicTable.style.display = 'table';
            basicTbody.innerHTML = '';
            if (data.seasons && data.seasons.length > 0) {
                data.seasons.forEach(season => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="season-year">${season.season}</td>
                        <td>${season.app || 0}</td>
                        <td>${season.ip ? formatInnings(season.ip) : '0.0'}</td>
                        <td>${season.w || 0}</td>
                        <td>${season.l || 0}</td>
                        <td>${season.sv || 0}</td>
                        <td>${season.hld || 0}</td>
                        <td>${season.k || 0}</td>
                        <td>${season.bb || 0}</td>
                        <td>${season.bk || 0}</td>
                        <td>${season.hbp || 0}</td>
                        <td>${season.gidp_pct ? (season.gidp_pct * 100).toFixed(1) : '0.0'}%</td>
                        <td>${season.r || 0}</td>
                        <td>${season.er || 0}</td>
                        <td>${season.h || 0}</td>
                        <td>${season.doubles || 0}</td>
                        <td>${season.triples || 0}</td>
                        <td>${season.hr || 0}</td>
                        <td>${season.era ? season.era.toFixed(2) : '0.00'}</td>
                        <td>${season.whip ? season.whip.toFixed(3) : '0.000'}</td>
                        <td>${season.baa ? season.baa.toFixed(3) : '.000'}</td>
                    `;
                    basicTbody.appendChild(row);
                });
            }

            
            // Make table sortable
            makeSortable(basicTable);
        }

        // Event listeners that need DOM to be loaded
        document.addEventListener('DOMContentLoaded', function() {
            
            // Split toggle functionality (copied from teams.html)
            document.querySelectorAll('.split-toggle button:not(.game-type-button)').forEach(button => {
                button.addEventListener('click', function(event) {
                    const buttons = document.querySelectorAll('.split-toggle button:not(.game-type-button)');
                    const isCtrlOrCmd = event.ctrlKey || event.metaKey;
                    if (isCtrlOrCmd) {
                        if (this.classList.contains('active') || this.classList.contains('multi-active')) {
                            const activeButtons = Array.from(buttons).filter(btn => btn.classList.contains('active') || btn.classList.contains('multi-active'));
                            if (activeButtons.length > 1) {
                                this.classList.remove('active', 'multi-active');
                            }
                        } else {
                            this.classList.add('multi-active');
                            const activeButton = Array.from(buttons).find(btn => btn.classList.contains('active'));
                            if (activeButton) {
                                activeButton.classList.remove('active');
                                activeButton.classList.add('multi-active');
                            }
                        }
                    } else {
                        buttons.forEach(btn => btn.classList.remove('active', 'multi-active'));
                        this.classList.add('active');
                    }
                    // Reload both batting and pitching stats when split changes
                    console.log('[DEBUG] Split button clicked, reloading stats...');
                    loadBallparkStats('batting');
                    loadBallparkStats('pitching');
                });
            });
            
            // Game type toggle functionality (copied from teams.html)
            document.querySelectorAll('.game-type-button').forEach(button => {
                button.addEventListener('click', function() {
                    this.classList.toggle('active');
                    // Reload both batting and pitching stats when game type changes
                    console.log('[DEBUG] Game type button clicked, reloading stats...');
                    loadBallparkStats('batting');
                    loadBallparkStats('pitching');
                });
            });
            
            // Recent games game type buttons
            document.querySelectorAll('.recent-game-type-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('.recent-game-type-button').forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    // Load recent games with new filter
                    loadRecentGames();
                });
            });
            
            // Add event listener for "Show More" button
            const showMoreBtn = document.getElementById('show-more-btn');
            if (showMoreBtn) {
                showMoreBtn.addEventListener('click', function() {
                    loadRecentGames(false); // false = don't reset, append more games
                });
            }
        });
    </script>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <p>&copy; 2025 yakyuu.jp</p>
            <p>This website is not affiliated with Nippon Professional Baseball (NPB) or any of its teams.</p>
            <p> Created by Lukas Pluckhahn (lukas@yakyuu.jp).</p>
        </div>
    </footer>
</body>
</html>