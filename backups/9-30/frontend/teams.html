<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Details - yakyuu.jp</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="style.css" id="main-stylesheet">
    <style>
        .page-container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 2rem;
        }
        /* --- Copied from player_template.html for stats section consistency --- */
        .table-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: flex-start;
        }
        .toggle-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .section-label {
            font-size: 0.8rem;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
        }
        .game-type-section .section-label {
            margin-left: 2rem;
        }
        .toggle-button {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            color: #666;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .toggle-button.active {
            background: #BC002D;
            color: white;
            border-color: #BC002D;
        }
        .toggle-button:hover {
            border-color: #BC002D;
            color: #BC002D;
        }
        .toggle-button.active:hover {
            background: #a00025;
            color: white;
        }

        .table-section {
            margin-bottom: 3rem;
        }
        .table-section h2 {
            color: #BC002D;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        .stats-container {
            margin-top: 2rem;
        }
        .basic-stats, .advanced-stats {
            margin-bottom: 2rem;
        }
        .basic-stats.full-width {
            width: 100%;
        }
        .stats-title {
            color: #BC002D;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .split-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .split-toggle button {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            color: #666;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 100px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .split-toggle button.active {
            background: #BC002D;
            color: white;
            border-color: #BC002D;
        }
        .split-toggle button.multi-active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .split-toggle button:hover {
            border-color: #BC002D;
            color: #BC002D;
        }
        .split-toggle button.active:hover {
            background: #a00025;
            color: white;
        }
        .split-helper-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 1rem;
            font-style: italic;
        }
        .split-helper-text a {
            color: #BC002D;
            text-decoration: none;
            font-weight: 500;
        }
        .split-helper-text a:hover {
            text-decoration: underline;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        .stats-table th {
            background: #BC002D;
            color: white;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 500;
            border-right: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        .stats-table th:hover {
            background: #a0001f;
        }
        .stats-table th.sortable::after {
            content: ' ↕';
            color: rgba(255,255,255,0.7);
            font-size: 12px;
        }
        .stats-table th.sort-asc::after {
            content: ' ↑';
            color: #fff;
        }
        .stats-table th.sort-desc::after {
            content: ' ↓';
            color: #fff;
        }
        .stats-table th:last-child {
            border-right: none;
        }
        .stats-table td {
            padding: 0.5rem;
            text-align: center;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
        }
        .stats-table td:last-child {
            border-right: none;
        }
        .stats-table tr:last-child td {
            border-bottom: none;
        }
        .stats-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .stats-table tr:hover {
            background: #e9ecef;
        }
        .career-row {
            background: #333 !important;
            color: white;
            font-weight: bold;
        }
        .career-row:hover {
            background: #444 !important;
        }
        .team-name {
            font-weight: 500;
            color: #333;
        }
        .season-year {
            font-weight: bold;
            color: #BC002D;
        }
        .table-container {
            overflow-x: auto;
        }
        .table-section.hidden {
            display: none;
        }
        /* --- End player_template.html CSS --- */
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #BC002D;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error State */
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }
        
        /* Team Header */
        .team-header-section {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }
        
        .team-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: #BC002D;
            margin-bottom: 0.5rem;
        }
        
        .team-record {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1rem;
        }
        
        .record-details {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .record-stat {
            text-align: center;
        }
        
        .record-stat .label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .record-stat .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        

        
        /* Leaders Section */
        .leaders-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .leaders-section h2 {
            color: #BC002D;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #BC002D;
            padding-bottom: 0.5rem;
        }
        
        .leaders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .leaders-category {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }
        
        .leaders-category h3 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
        }
        
        .leader-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .leader-item:last-child {
            border-bottom: none;
        }
        
        .leader-name {
            font-weight: 500;
            color: #333;
        }
        
        .leader-name a {
            color: #BC002D;
            text-decoration: none;
        }
        
        .leader-name a:hover {
            text-decoration: underline;
        }
        
        .leader-stat {
            font-weight: bold;
            color: #495057;
        }
        
        /* Toggle Buttons */
        .toggle-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .toggle-btn {
            padding: 0.75rem 2rem;
            border: 2px solid #BC002D;
            background: #fff;
            color: #BC002D;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .toggle-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(188, 0, 45, 0.2);
        }
        
        .toggle-btn.active {
            background: #BC002D;
            color: #fff;
        }
        
        .toggle-btn.active:hover {
            background: #a00025;
        }
        
        /* Content Sections */
        .content-section {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Games Section */
        .games-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .games-section h2 {
            color: #BC002D;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #BC002D;
            padding-bottom: 0.5rem;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .page-container {
                padding: 1rem;
            }
            
            .team-name {
                font-size: 2rem;
            }
            
            .record-details {
                flex-direction: column;
                gap: 1rem;
            }
            
            .toggle-buttons {
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
            }
            
            .toggle-btn {
                min-width: 200px;
            }
            
            .leaders-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Recent Games Controls */
        .recent-games-controls {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .recent-games-controls label {
            font-weight: 500;
            color: #333;
        }
        
        .recent-games-controls select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
        }
        
        .recent-games-controls select:focus {
            outline: none;
            border-color: #BC002D;
        }
        
        /* Loading and Error Messages */
        .loading-message, .error-message {
            text-align: center;
            padding: 2rem;
            font-style: italic;
            color: #666;
        }
        
        .error-message {
            color: #dc3545;
        }
        

        
        .home-away {
            font-weight: bold;
            color: #BC002D;
        }
        
        /* Recent Games Cards */
        #recent-games-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .game-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s ease;
        }
        
        .game-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        

        
        .game-line-score {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            font-size: 0.9rem;
        }
        
        .game-line-score th {
            background: #f8f9fa;
            color: #333;
            padding: 0.5rem;
            text-align: center;
            font-weight: 500;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
        }
        
        .game-line-score th:last-child {
            border-right: none;
        }
        
        .game-line-score td {
            padding: 0.5rem;
            text-align: center;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
        }
        
        .game-line-score td:last-child {
            border-right: none;
        }
        
        .game-line-score tr:last-child td {
            border-bottom: none;
        }
        
        .game-line-score .team-name {
            font-weight: 500;
            color: #333;
            text-align: left;
            padding-left: 1rem;
            font-size: 0.85rem;
        }
        
        .game-line-score .winning-score {
            font-weight: bold;
            color: #BC002D;
            font-size: 1.1rem;
        }
        
        .game-info-header {
            background: #BC002D !important;
            color: white !important;
            font-size: 0.85rem !important;
            font-weight: 500 !important;
            text-align: center !important;
            padding: 0.75rem !important;
        }
        
        .show-more-button {
            background: #BC002D;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .show-more-button:hover {
            background: #a00025;
        }
        
        .show-more-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <script>
        // Fix paths based on protocol (file:// vs http://)
        if (window.location.protocol !== 'file:') {
            // We're on a web server, use absolute paths
            document.getElementById('main-stylesheet').href = '/style.css';
            document.getElementById('main-logo').src = '/logo.png';
            
            // Add absolute font path for web server
            const style = document.createElement('style');
            style.textContent = `
                @font-face {
                    font-family: 'Titillium Web';
                    src: url('/TitilliumWeb-Regular.ttf') format('truetype');
                    font-weight: normal;
                    font-style: normal;
                }
            `;
            document.head.appendChild(style);
        }
    </script>
    
    <!-- Large Header with Logo -->
    <header class="main-header">
        <div class="header-content">
            <a href="/" class="logo-link">
                <img src="logo.png" alt="yakyuu.jp" class="logo-image" id="main-logo">
            </a>
        </div>
    </header>

    <!-- Red Navigation Bar -->
    <nav class="main-nav">
        <div class="nav-content">
            <ul class="nav-menu">
                <li><a href="/games">Games</a></li>
                <li><a href="/players">Players</a></li>
                <li><a href="/teams">Teams/Standings</a></li>
                <li><a href="/ballparks">Ballparks</a></li>
                <li><a href="/advanced">Advanced Stat Finder</a></li>
                <li><a href="/about">About</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-container">
            <div id="loading" class="loading">Loading team data...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="team-content" style="display: none;">
                
                <!-- Team Header Section -->
                <div class="team-header-section">
                    <h1 class="team-name" id="team-name">Team Name</h1>
                    <div class="team-record" id="team-record">0-0-0 (.000)</div>
                    <div class="record-details">
                        <div class="record-stat">
                            <div class="label">League</div>
                            <div class="value" id="team-league">-</div>
                        </div>
                        <div class="record-stat">
                            <div class="label">Founded</div>
                            <div class="value" id="team-first-year">-</div>
                        </div>
                        <div class="record-stat">
                            <div class="label">Home Ballpark</div>
                            <div class="value" id="team-ballpark">-</div>
                        </div>
                    </div>
                </div>

                <!-- Team Leaders Section (always visible) -->
                <div class="leaders-section">
                    <h2>Team Leaders</h2>
                    <div class="leaders-grid">
                        <!-- Batting Leaders -->
                        <div class="leaders-category">
                            <h3>Batting Leaders</h3>
                            <div id="batting-leaders">
                                <div class="leader-item">
                                    <span class="leader-name">Hits: <span id="hits-leader">Loading...</span></span>
                                    <span class="leader-stat" id="hits-stat">-</span>
                                </div>
                                <div class="leader-item">
                                    <span class="leader-name">Home Runs: <span id="hr-leader">Loading...</span></span>
                                    <span class="leader-stat" id="hr-stat">-</span>
                                </div>
                                <div class="leader-item">
                                    <span class="leader-name">RBI: <span id="rbi-leader">Loading...</span></span>
                                    <span class="leader-stat" id="rbi-stat">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pitching Leaders -->
                        <div class="leaders-category">
                            <h3>Pitching Leaders</h3>
                            <div id="pitching-leaders">
                                <div class="leader-item">
                                    <span class="leader-name">ERA: <span id="era-leader">Loading...</span></span>
                                    <span class="leader-stat" id="era-stat">-</span>
                                </div>
                                <div class="leader-item">
                                    <span class="leader-name">WHIP: <span id="whip-leader">Loading...</span></span>
                                    <span class="leader-stat" id="whip-stat">-</span>
                                </div>
                                <div class="leader-item">
                                    <span class="leader-name">Strikeouts: <span id="k-leader">Loading...</span></span>
                                    <span class="leader-stat" id="k-stat">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Toggle Buttons -->
                <div class="toggle-buttons">
                    <button id="team-stats-btn" class="toggle-btn active" onclick="showTeamStats()">Team Stats</button>
                    <button id="recent-games-btn" class="toggle-btn" onclick="showRecentGames()">Recent Games</button>
                </div>

                <!-- Team Stats Section -->
                <div id="team-stats-section" class="content-section">
                    <!-- Team Stats Controls -->
                    <div class="table-toggle">
                        <div class="toggle-section">
                            <div class="section-label">Game Type</div>
                            <div class="split-toggle">
                                <button class="game-type-button active" data-game-type="公式戦">Regular Season</button>
                                <button class="game-type-button" data-game-type="ファーストステージ">Postseason First</button>
                                <button class="game-type-button" data-game-type="ファイナルステージ">Postseason Final</button>
                                <button class="game-type-button" data-game-type="日本シリーズ">Japan Series</button>
                            </div>
                        </div>
                    </div>

                    <!-- Batting Stats Section -->
                    <div class="table-section" id="team-batting-section">
                        <div class="toggle-section">
                            <div class="section-label">Split</div>
                            <div class="split-toggle">
                                <button class="active">Overall</button>
                                <button>Home</button>
                                <button>Road</button>
                                <button>Wins</button>
                                <button>Losses</button>
                            </div>
                            <div class="split-helper-text">Hold Ctrl/Cmd to select multiple splits (AND logic). For custom splits, visit <a href="/advanced">Advanced Stat Finder</a></div>
                        </div>
                        <h2>Batting Statistics</h2>
                        <div class="stats-container">
                            <div class="basic-stats full-width">
                                <div class="loading" id="team-batting-basic-loading">Loading basic statistics...</div>
                                <table class="stats-table" id="team-batting-basic-table" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Season</th>
                                            <th>G</th>
                                            <th>PA</th>
                                            <th>AB</th>
                                            <th>H</th>
                                            <th>R</th>
                                            <th>2B</th>
                                            <th>3B</th>
                                            <th>HR</th>
                                            <th>TB</th>
                                            <th>RBI</th>
                                            <th>K</th>
                                            <th>BB</th>
                                            <th>HBP</th>
                                            <th>SAC</th>
                                            <th>GIDP</th>
                                            <th>AVG</th>
                                            <th>SLG</th>
                                            <th>ISO</th>
                                            <th>BABIP</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team-batting-basic-tbody">
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>

                    <!-- Pitching Stats Section -->
                    <div class="table-section" id="team-pitching-section">
                        <h2>Pitching Statistics</h2>
                        <div class="stats-container">
                            <div class="basic-stats full-width">
                                <div class="loading" id="team-pitching-basic-loading">Loading pitching statistics...</div>
                                <table class="stats-table" id="team-pitching-basic-table" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Season</th>
                                            <th>App</th>
                                            <th>IP</th>
                                            <th>W</th>
                                            <th>L</th>
                                            <th>SV</th>
                                            <th>HLD</th>
                                            <th>K</th>
                                            <th>BB</th>
                                            <th>BK</th>
                                            <th>HBP</th>
                                            <th>GIDP%</th>
                                            <th>R</th>
                                            <th>ER</th>
                                            <th>H</th>
                                            <th>2B</th>
                                            <th>3B</th>
                                            <th>HR</th>
                                            <th>ERA</th>
                                            <th>WHIP</th>
                                            <th>BAA</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team-pitching-basic-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Games Section -->
                <div id="recent-games-section" class="content-section" style="display: none;">
                    <div class="games-section">
                        <h2>Recent Games</h2>
                        
                        <div class="recent-games-controls">
                            <div class="toggle-section">
                                <div class="section-label">Game Type</div>
                                <div class="split-toggle">
                                    <button class="recent-game-type-button active" data-game-type="">All Games</button>
                                    <button class="recent-game-type-button" data-game-type="公式戦">Regular Season</button>
                                    <button class="recent-game-type-button" data-game-type="ファーストステージ">Postseason First</button>
                                    <button class="recent-game-type-button" data-game-type="ファイナルステージ">Postseason Final</button>
                                    <button class="recent-game-type-button" data-game-type="日本シリーズ">Japan Series</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="recent-games-container">
                            <!-- Games will be loaded here as individual cards -->
                        </div>
                        
                        <div id="show-more-container" style="display: none; text-align: center; margin-top: 1rem;">
                            <button id="show-more-btn" class="show-more-button">Show 10 More</button>
                        </div>
                        
                        <div id="recent-games-loading" class="loading-message" style="display: none;">
                            Loading recent games...
                        </div>
                        
                        <div id="recent-games-error" class="error-message" style="display: none;">
                            Failed to load recent games.
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </main>

    <script>
    // Get team ID from URL path
    function getTeamIdFromPath() {
        const path = window.location.pathname;
        const segments = path.split('/');
        // Look for /teams/{teamId} pattern
        const teamsIndex = segments.indexOf('teams');
        if (teamsIndex !== -1 && segments[teamsIndex + 1]) {
            return segments[teamsIndex + 1];
        }
        // Fallback to URL parameters for backward compatibility
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id') || 'h'; // Default to Hanshin for testing
    }
    
    const teamId = getTeamIdFromPath();
    const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:5000/api' : '/api';
    
    // Pagination state for recent games
    let currentOffset = 0;

    // Toggle Functions
    function showTeamStats() {
        document.getElementById('team-stats-btn').classList.add('active');
        document.getElementById('recent-games-btn').classList.remove('active');
        document.getElementById('team-stats-section').style.display = 'block';
        document.getElementById('recent-games-section').style.display = 'none';
    }
    function showRecentGames() {
        document.getElementById('team-stats-btn').classList.remove('active');
        document.getElementById('recent-games-btn').classList.add('active');
        document.getElementById('team-stats-section').style.display = 'none';
        document.getElementById('recent-games-section').style.display = 'block';
        
        // Load recent games when section is shown
        loadRecentGames();
    }

    // --- TEAM STATS LOGIC ---
    function getActiveGameTypes() {
        return Array.from(document.querySelectorAll('.game-type-button.active')).map(btn => btn.dataset.gameType);
    }
    function getActiveSplits(sectionId) {
        const buttons = document.querySelectorAll(`#${sectionId} .split-toggle button`);
        const activeSplits = [];
        buttons.forEach(button => {
            if (button.classList.contains('active') || button.classList.contains('multi-active')) {
                activeSplits.push(button.textContent.trim());
            }
        });
        return activeSplits.length > 0 ? activeSplits : ['Overall'];
    }

    function formatInnings(ip) {
        // Convert decimal innings to standard baseball format (e.g., 123.33 -> 123.1, 123.67 -> 123.2)
        if (!ip) return '0.0';
        const wholeInnings = Math.floor(ip);
        const fraction = ip - wholeInnings;
        let outs = Math.round(fraction * 3);
        if (outs >= 3) {
            return (wholeInnings + 1) + '.0';
        }
        return wholeInnings + '.' + outs;
    }

    async function loadTeamStats(statType) {
        // statType: 'batting' or 'pitching'
        const gameTypes = getActiveGameTypes();
        const splits = getActiveSplits('team-batting-section');
        const url = `${API_BASE}/teams/${teamId}/${statType}?` +
            gameTypes.map(gt => `game_types[]=${encodeURIComponent(gt)}`).join('&') +
            (splits.length ? '&' + splits.map(s => `splits[]=${encodeURIComponent(s)}`).join('&') : '');
        console.log(`[DEBUG] Fetching team stats:`, url);
        try {
            const resp = await fetch(url);
            console.log(`[DEBUG] Response status:`, resp.status);
            if (!resp.ok) {
                const msg = `API error: ${resp.status} ${resp.statusText}`;
                if (statType === 'batting') {
                    document.getElementById('team-batting-basic-loading').innerHTML = `<div class='error'>${msg}</div>`;
                    document.getElementById('team-batting-advanced-loading').innerHTML = `<div class='error'>${msg}</div>`;
                } else {
                    document.getElementById('team-pitching-basic-loading').innerHTML = `<div class='error'>${msg}</div>`;
                    document.getElementById('team-pitching-advanced-loading').innerHTML = `<div class='error'>${msg}</div>`;
                }
                return;
            }
            const data = await resp.json();
            console.log(`[DEBUG] API data:`, data);
            if (statType === 'batting') {
                renderTeamBattingStats(data);
            } else {
                renderTeamPitchingStats(data);
            }
        } catch (e) {
            console.error(`[DEBUG] Fetch error:`, e);
            if (statType === 'batting') {
                document.getElementById('team-batting-basic-loading').innerHTML = `<div class='error'>Fetch error: ${e.message}</div>`;
            } else {
                document.getElementById('team-pitching-basic-loading').innerHTML = `<div class='error'>Fetch error: ${e.message}</div>`;
            }
        }
    }

    function renderTeamBattingStats(data) {
        // Basic
        const basicTbody = document.getElementById('team-batting-basic-tbody');
        const basicTable = document.getElementById('team-batting-basic-table');
        const basicLoading = document.getElementById('team-batting-basic-loading');
        basicLoading.style.display = 'none';
        basicTable.style.display = 'table';
        basicTbody.innerHTML = '';
        if (data.seasons && data.seasons.length > 0) {
            data.seasons.forEach(season => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="season-year">${season.season}</td>
                    <td>${season.g || 0}</td>
                    <td>${season.pa || 0}</td>
                    <td>${season.ab || 0}</td>
                    <td>${season.h || 0}</td>
                    <td>${season.r || 0}</td>
                    <td>${season.doubles || 0}</td>
                    <td>${season.triples || 0}</td>
                    <td>${season.hr || 0}</td>
                    <td>${season.tb || 0}</td>
                    <td>${season.rbi || 0}</td>
                    <td>${season.so || 0}</td>
                    <td>${season.bb || 0}</td>
                    <td>${season.hbp || 0}</td>
                    <td>${season.sac || 0}</td>
                    <td>${season.gidp || 0}</td>
                    <td>${season.avg ? season.avg.toFixed(3) : '.000'}</td>
                    <td>${season.slg ? season.slg.toFixed(3) : '.000'}</td>
                    <td>${season.iso ? season.iso.toFixed(3) : '.000'}</td>
                    <td>${season.babip ? season.babip.toFixed(3) : '.000'}</td>
                `;
                basicTbody.appendChild(row);
            });
        }
        // Make table sortable
        makeSortable(basicTable);
    }

    function renderTeamPitchingStats(data) {
        // Combined pitching stats table
        const basicTbody = document.getElementById('team-pitching-basic-tbody');
        const basicTable = document.getElementById('team-pitching-basic-table');
        const basicLoading = document.getElementById('team-pitching-basic-loading');
        basicLoading.style.display = 'none';
        basicTable.style.display = 'table';
        basicTbody.innerHTML = '';
        if (data.seasons && data.seasons.length > 0) {
            data.seasons.forEach(season => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="season-year">${season.season}</td>
                    <td>${season.app || 0}</td>
                    <td>${season.ip ? formatInnings(season.ip) : '0.0'}</td>
                    <td>${season.w || 0}</td>
                    <td>${season.l || 0}</td>
                    <td>${season.sv || 0}</td>
                    <td>${season.hld || 0}</td>
                    <td>${season.k || 0}</td>
                    <td>${season.bb || 0}</td>
                    <td>${season.bk || 0}</td>
                    <td>${season.hbp || 0}</td>
                    <td>${season.gidp_pct ? (season.gidp_pct * 100).toFixed(1) : '0.0'}%</td>
                    <td>${season.r || 0}</td>
                    <td>${season.er || 0}</td>
                    <td>${season.h || 0}</td>
                    <td>${season.doubles || 0}</td>
                    <td>${season.triples || 0}</td>
                    <td>${season.hr || 0}</td>
                    <td>${season.era ? season.era.toFixed(2) : '0.00'}</td>
                    <td>${season.whip ? season.whip.toFixed(3) : '0.000'}</td>
                    <td>${season.baa ? season.baa.toFixed(3) : '.000'}</td>
                `;
                basicTbody.appendChild(row);
            });
        }
        // Make table sortable
        makeSortable(basicTable);
    }


    // Split toggle functionality
    document.querySelectorAll('.split-toggle button').forEach(button => {
        button.addEventListener('click', function(event) {
            const section = this.closest('.table-section');
            const buttons = section.querySelectorAll('.split-toggle button');
            const isCtrlOrCmd = event.ctrlKey || event.metaKey;
            if (isCtrlOrCmd) {
                if (this.classList.contains('active') || this.classList.contains('multi-active')) {
                    const activeButtons = Array.from(buttons).filter(btn => btn.classList.contains('active') || btn.classList.contains('multi-active'));
                    if (activeButtons.length > 1) {
                        this.classList.remove('active', 'multi-active');
                    }
                } else {
                    this.classList.add('multi-active');
                    const activeButton = Array.from(buttons).find(btn => btn.classList.contains('active'));
                    if (activeButton) {
                        activeButton.classList.remove('active');
                        activeButton.classList.add('multi-active');
                    }
                }
            } else {
                buttons.forEach(btn => btn.classList.remove('active', 'multi-active'));
                this.classList.add('active');
            }
            // Reload both batting and pitching stats when split changes
            loadTeamStats('batting');
            loadTeamStats('pitching');
        });
    });
    // Game type toggle functionality
    document.querySelectorAll('.game-type-button').forEach(button => {
        button.addEventListener('click', function() {
            this.classList.toggle('active');
            // Reload both batting and pitching stats when game type changes
            loadTeamStats('batting');
            loadTeamStats('pitching');
        });
    });

    // --- END TEAM STATS LOGIC ---

    // Table sorting functionality
    function makeSortable(table) {
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if (index === 0) return; // Don't sort by Season column
            
            header.classList.add('sortable');
            header.addEventListener('click', () => {
                sortTable(table, index, header);
            });
        });
    }
    
    function sortTable(table, columnIndex, header) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const careerRow = rows.find(row => row.classList.contains('career-row'));
        const dataRows = rows.filter(row => !row.classList.contains('career-row'));
        
        // Determine sort direction
        const isAscending = !header.classList.contains('sort-asc');
        
        // Clear all sort classes
        table.querySelectorAll('th').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Add appropriate sort class
        header.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
        
        // Sort the data rows
        dataRows.sort((a, b) => {
            const aValue = getCellValue(a, columnIndex);
            const bValue = getCellValue(b, columnIndex);
            
            if (aValue === bValue) return 0;
            
            const result = aValue > bValue ? 1 : -1;
            return isAscending ? result : -result;
        });
        
        // Clear tbody and re-append sorted rows
        tbody.innerHTML = '';
        dataRows.forEach(row => tbody.appendChild(row));
        
        // Always append career row last if it exists
        if (careerRow) {
            tbody.appendChild(careerRow);
        }
    }
    
    function getCellValue(row, columnIndex) {
        const cell = row.cells[columnIndex];
        const text = cell.textContent.trim();
        
        // Handle percentages
        if (text.includes('%')) {
            return parseFloat(text.replace('%', '')) || 0;
        }
        
        // Handle numeric values
        const num = parseFloat(text);
        if (!isNaN(num)) {
            return num;
        }
        
        // Handle text values
        return text.toLowerCase();
    }

    // Load team data (metadata, record, leaders)
    async function loadTeamData() {
        try {
            const teamResponse = await fetch(`${API_BASE}/teams/${teamId}`);
            if (!teamResponse.ok) throw new Error(`Team not found: ${teamResponse.status}`);
            const teamData = await teamResponse.json();
            const recordResponse = await fetch(`${API_BASE}/teams/${teamId}/record`);
            const recordData = recordResponse.ok ? await recordResponse.json() : { wins: 0, losses: 0, ties: 0, win_pct: 0.000 };
            const leadersResponse = await fetch(`${API_BASE}/team-leaders/${teamId}`);
            const leadersData = leadersResponse.ok ? await leadersResponse.json() : { batting_leaders: {}, pitching_leaders: {} };
            populateTeamData(teamData, recordData, leadersData);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('team-content').style.display = 'block';
            // Load both batting and pitching stats
            loadTeamStats('batting');
            loadTeamStats('pitching');
        } catch (error) {
            console.error('Error loading team data:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = `Error loading team data: ${error.message}`;
        }
    }

    // ...existing code for populateTeamData, populateLeaders, getLeagueName...
    function populateTeamData(teamData, recordData, leadersData) {
        const teamDisplayName = teamData.team_name_en 
            ? `${teamData.team_name} (${teamData.team_name_en})`
            : teamData.team_name;
        document.getElementById('team-name').textContent = teamDisplayName;
        document.title = `${teamDisplayName} - yakyuu.jp`;
        const winPct = recordData.win_pct || 0.000;
        document.getElementById('team-record').textContent = 
            `${recordData.wins || 0}-${recordData.losses || 0}-${recordData.ties || 0} (${winPct.toFixed(3)})`;
        document.getElementById('team-league').textContent = getLeagueName(teamData.league) || '-';
        document.getElementById('team-first-year').textContent = teamData.first_year || '-';
        document.getElementById('team-ballpark').textContent = teamData.ballpark || '-';
        populateLeaders(leadersData);
    }
    function populateLeaders(leadersData) {
        const batting = leadersData.batting_leaders || {};
        const pitching = leadersData.pitching_leaders || {};
        if (batting.hits && batting.hits.length > 0) {
            const hitsLeader = batting.hits[0];
            document.getElementById('hits-leader').innerHTML = `<a href="/player?id=${hitsLeader.player_id}">${hitsLeader.name}</a>`;
            document.getElementById('hits-stat').textContent = hitsLeader.stat;
        } else {
            document.getElementById('hits-leader').textContent = 'No data';
            document.getElementById('hits-stat').textContent = '-';
        }
        if (batting.hr && batting.hr.length > 0) {
            const hrLeader = batting.hr[0];
            document.getElementById('hr-leader').innerHTML = `<a href="/player?id=${hrLeader.player_id}">${hrLeader.name}</a>`;
            document.getElementById('hr-stat').textContent = hrLeader.stat;
        } else {
            document.getElementById('hr-leader').textContent = 'No data';
            document.getElementById('hr-stat').textContent = '-';
        }
        if (batting.rbi && batting.rbi.length > 0) {
            const rbiLeader = batting.rbi[0];
            document.getElementById('rbi-leader').innerHTML = `<a href="/player?id=${rbiLeader.player_id}">${rbiLeader.name}</a>`;
            document.getElementById('rbi-stat').textContent = rbiLeader.stat;
        } else {
            document.getElementById('rbi-leader').textContent = 'No data';
            document.getElementById('rbi-stat').textContent = '-';
        }
        if (pitching.era && pitching.era.length > 0) {
            const eraLeader = pitching.era[0];
            document.getElementById('era-leader').innerHTML = `<a href="/player?id=${eraLeader.player_id}">${eraLeader.name}</a>`;
            document.getElementById('era-stat').textContent = eraLeader.stat;
        } else {
            document.getElementById('era-leader').textContent = 'No data';
            document.getElementById('era-stat').textContent = '-';
        }
        if (pitching.whip && pitching.whip.length > 0) {
            const whipLeader = pitching.whip[0];
            document.getElementById('whip-leader').innerHTML = `<a href="/player?id=${whipLeader.player_id}">${whipLeader.name}</a>`;
            document.getElementById('whip-stat').textContent = whipLeader.stat;
        } else {
            document.getElementById('whip-leader').textContent = 'No data';
            document.getElementById('whip-stat').textContent = '-';
        }
        if (pitching.k && pitching.k.length > 0) {
            const kLeader = pitching.k[0];
            document.getElementById('k-leader').innerHTML = `<a href="/player?id=${kLeader.player_id}">${kLeader.name}</a>`;
            document.getElementById('k-stat').textContent = kLeader.stat;
        } else {
            document.getElementById('k-leader').textContent = 'No data';
            document.getElementById('k-stat').textContent = '-';
        }
    }
    function getLeagueName(league) {
        switch(league) {
            case 'cl': return 'Central League';
            case 'pl': return 'Pacific League';
            default: return league;
        }
    }
    
    // --- RECENT GAMES LOGIC ---
    
    // Add event listeners for recent games controls
    document.addEventListener('DOMContentLoaded', function() {
        // Fix logo path for localhost
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            const logoImg = document.querySelector('.logo-image');
            if (logoImg) {
                logoImg.src = '/logo.png';
            }
        }
        
        loadTeamData();
        
        // Add event listeners for recent games controls
        document.querySelectorAll('.recent-game-type-button').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.recent-game-type-button').forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                // Load recent games with new filter
                loadRecentGames();
            });
        });
        
        // Add event listener for "Show More" button
        document.getElementById('show-more-btn').addEventListener('click', function() {
            loadRecentGames(true); // true = append mode
        });
    });
    
    // Load recent games function
    function loadRecentGames(append = false) {
        const limit = 10; // Fixed to show last 10 games
        const activeButton = document.querySelector('.recent-game-type-button.active');
        const gameType = activeButton ? activeButton.dataset.gameType : '';
        const loadingEl = document.getElementById('recent-games-loading');
        const errorEl = document.getElementById('recent-games-error');
        const containerEl = document.getElementById('recent-games-container');
        const showMoreContainer = document.getElementById('show-more-container');
        
        // Reset offset if not appending (new search)
        if (!append) {
            currentOffset = 0;
        }
        
        // Show loading state
        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';
        if (!append) {
            containerEl.style.display = 'none';
            showMoreContainer.style.display = 'none';
        }
        
        // Build API URL
        let apiUrl = `${API_BASE}/teams/${teamId}/recent-games?limit=${limit}&offset=${currentOffset}`;
        if (gameType) {
            apiUrl += `&game_types[]=${encodeURIComponent(gameType)}`;
        }
        
        // Fetch recent games
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch recent games');
                }
                return response.json();
            })
            .then(data => {
                // Hide loading state
                loadingEl.style.display = 'none';
                
                if (data.games && data.games.length > 0) {
                    // Show container and populate data
                    containerEl.style.display = 'block';
                    populateRecentGamesCards(data.games, append);
                    
                    // Update offset for next load
                    currentOffset += data.games.length;
                    
                    // Show "Show More" button if there are more games
                    if (data.has_more) {
                        showMoreContainer.style.display = 'block';
                    }
                } else if (!append) {
                    // Show no games message only if this is the first load
                    containerEl.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No recent games found</div>';
                    containerEl.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading recent games:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
            });
    }
    
    // Populate recent games cards
    function populateRecentGamesCards(games, append = false) {
        const container = document.getElementById('recent-games-container');
        if (!append) {
            container.innerHTML = '';
        }
        
        games.forEach(game => {
            const gameCard = document.createElement('div');
            gameCard.className = 'game-card';
            
            // Format date as yyyy/mm/dd - avoid timezone issues by parsing manually
            const dateParts = game.date.split('-');
            const date = `${dateParts[0]}/${dateParts[1]}/${dateParts[2]}`;
            
            // Use the data from API with proper formatting
            const ourTeam = `${game.team_name} (${game.team_name_en})`;
            const opponentTeam = `${game.opponent_name} (${game.opponent_name_en})`;
            const ourRuns = game.team_runs;
            const opponentRuns = game.opponent_runs;
            const ourHits = game.team_hits || 0;
            const opponentHits = game.opponent_hits || 0;
            const ourErrors = game.team_errors || 0;
            const opponentErrors = game.opponent_errors || 0;
            
            // Determine winning team styling
            const ourScoreClass = ourRuns > opponentRuns ? 'winning-score' : '';
            const opponentScoreClass = opponentRuns > ourRuns ? 'winning-score' : '';
            
            // Format game type with English translation
            const gameTypeMap = {
                '公式戦': 'Regular Season',
                '交流戦': 'Interleague',
                'ファーストステージ': 'First Stage',
                'ファイナルステージ': 'Final Stage', 
                '日本シリーズ': 'Japan Series'
            };
            const gameTypeEn = gameTypeMap[game.gametype] || game.gametype;
            const gameTypeDisplay = `${game.gametype} (${gameTypeEn})`;
            
            // Format game number
            const gameNumberDisplay = game.game_number ? `第${game.game_number}回戦 (Game ${game.game_number})` : '';
            
            // Format ballpark info
            const ballparkDisplay = game.park_name && game.park_name_en ? 
                `${game.park_name} (${game.park_name_en})` : 
                (game.ballpark || '');
            
            // Create the game info header that will go in the table
            const gameInfoHeader = `${date} | ${gameTypeDisplay}${gameNumberDisplay ? ' | ' + gameNumberDisplay : ''}${ballparkDisplay ? ' | ' + ballparkDisplay : ''}`;
            
            gameCard.innerHTML = `
                <table class="game-line-score">
                    <thead>
                        <tr>
                            <th colspan="4" class="game-info-header">${gameInfoHeader}</th>
                        </tr>
                        <tr>
                            <th>Team</th>
                            <th>R</th>
                            <th>H</th>
                            <th>E</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${game.home_away === 'away' ? `
                        <tr>
                            <td class="team-name">${ourTeam}</td>
                            <td class="${ourScoreClass}">${ourRuns}</td>
                            <td>${ourHits}</td>
                            <td>${ourErrors}</td>
                        </tr>
                        <tr>
                            <td class="team-name">${opponentTeam}</td>
                            <td class="${opponentScoreClass}">${opponentRuns}</td>
                            <td>${opponentHits}</td>
                            <td>${opponentErrors}</td>
                        </tr>
                        ` : `
                        <tr>
                            <td class="team-name">${opponentTeam}</td>
                            <td class="${opponentScoreClass}">${opponentRuns}</td>
                            <td>${opponentHits}</td>
                            <td>${opponentErrors}</td>
                        </tr>
                        <tr>
                            <td class="team-name">${ourTeam}</td>
                            <td class="${ourScoreClass}">${ourRuns}</td>
                            <td>${ourHits}</td>
                            <td>${ourErrors}</td>
                        </tr>
                        `}
                    </tbody>
                </table>
            `;
            
            container.appendChild(gameCard);
        });
    }
    
    </script>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <p>&copy; 2025 yakyuu.jp</p>
            <p>This website is not affiliated with Nippon Professional Baseball (NPB) or any of its teams.</p>
            <p> Created by Lukas Pluckhahn (lukas@yakyuu.jp).</p>
        </div>
    </footer>
</body>
</html>